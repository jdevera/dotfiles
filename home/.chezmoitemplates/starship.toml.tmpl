{{- /*
Starship Configuration Template - Layered Merge

┌────────────────────────────────────────────────────────────────┐
│ Layer 1: nerd-font-symbols.toml                                │
│ (downloaded from starship.rs, stored in repo)                  │
│ Contains: all [module] symbol = "xxx" definitions              │
└───────────────────────────┬────────────────────────────────────┘
                            │ fromToml
                            ▼
┌────────────────────────────────────────────────────────────────┐
│ Layer 2: catppuccin-theme.toml (optional, future)              │
│ Contains: [palettes.*] color definitions                       │
└───────────────────────────┬────────────────────────────────────┘
                            │ mergeOverwrite
                            ▼
┌────────────────────────────────────────────────────────────────┐
│ Layer 3: starship.yml (custom settings)                        │
│ Contains: character, directory style, git_branch style,        │
│           custom modules (window_title, chezmoi, exit_*)       │
└───────────────────────────┬────────────────────────────────────┘
                            │ mergeOverwrite
                            ▼
               ┌────────────┴────────────┐
               ▼                         ▼
       starship.toml           starship-ascii-prompt.toml

Usage:
  {{ template "starship.toml.tmpl" (dict "ascii_prompt" false) }}
  {{ template "starship.toml.tmpl" (dict "ascii_prompt" true) }}
*/ -}}
{{- /* Load base preset from static file */ -}}
{{- $base := include ".chezmoitemplates/starship/nerd-font-symbols.toml" | fromToml -}}

{{- /* Get custom settings from chezmoidata */ -}}
{{- $cfg := .starship -}}

{{- /* Set top-level palette */ -}}
{{- $_ := set $base "palette" $cfg.palette -}}

{{- /* Merge custom module settings (directory, git_branch, etc.) */ -}}
{{- range $module, $settings := $cfg.custom_modules -}}
{{-   $existing := index $base $module | default dict -}}
{{-   $_ := set $base $module (mergeOverwrite $existing $settings) -}}
{{- end -}}

{{- /* Add custom modules (window_title, chezmoi) */ -}}
{{- $customModules := index $base "custom" | default dict -}}
{{- range $name, $settings := $cfg.custom -}}
{{-   $_ := set $customModules $name $settings -}}
{{- end -}}

{{- /* For ASCII variant, also add exit_ok and exit_err custom modules */ -}}
{{- if .ascii_prompt -}}
{{-   range $name, $settings := $cfg.ascii_custom -}}
{{-     $_ := set $customModules $name $settings -}}
{{-   end -}}
{{- end -}}
{{- $_ := set $base "custom" $customModules -}}

{{- /* Set character symbols based on variant */ -}}
{{- if .ascii_prompt -}}
{{-   $_ := set $base "character" $cfg.character.ascii -}}
{{- else -}}
{{-   $_ := set $base "character" $cfg.character.unicode -}}
{{- end -}}

{{- /* Add palette definitions */ -}}
{{- $_ := set $base "palettes" $cfg.palettes -}}

{{- /* Output the merged config as TOML */ -}}
# Get editor completions based on the config schema
{{ if .ascii_prompt -}}
# Starship config with ASCII-safe prompt line
# Uses text-based symbols for the prompt to avoid rendering issues in some terminals
# See: https://github.com/starship/starship/issues/6923
# See: https://github.com/ghostty-org/ghostty/discussions/5823

# Custom format to place exit status on line 2 (before character, not with other modules)
# Note: $custom.window_title and $custom.chezmoi go on line 1, exit modules on line 2
format = """
${custom.window_title}\
$username\
$hostname\
$localip\
$shlvl\
$singularity\
$kubernetes\
$directory\
$vcsh\
$fossil_branch\
$fossil_metrics\
$git_branch\
$git_commit\
$git_state\
$git_metrics\
$git_status\
$hg_branch\
$pijul_channel\
$docker_context\
$package\
$c\
$cmake\
$cobol\
$daml\
$dart\
$deno\
$dotnet\
$elixir\
$elm\
$erlang\
$fennel\
$gleam\
$golang\
$gradle\
$haskell\
$haxe\
$helm\
$java\
$julia\
$kotlin\
$lua\
$nim\
$nodejs\
$ocaml\
$opa\
$perl\
$php\
$pulumi\
$purescript\
$python\
$quarto\
$raku\
$rlang\
$red\
$ruby\
$rust\
$scala\
$solidity\
$swift\
$terraform\
$typst\
$vlang\
$vagrant\
$zig\
$buf\
$guix_shell\
$nix_shell\
$conda\
$meson\
$spack\
$memory_usage\
$aws\
$gcloud\
$openstack\
$azure\
$direnv\
$env_var\
$crystal\
${custom.chezmoi}\
$sudo\
$cmd_duration\
$line_break\
$jobs\
$battery\
$time\
$shell\
${custom.exit_ok}\
${custom.exit_err}\
$character"""

{{ else -}}
# Starship config with full Unicode/Nerd Font prompt symbols
# For terminals with Unicode rendering issues, use starship-ascii-prompt.toml instead

{{ end -}}
{{ toToml $base }}
